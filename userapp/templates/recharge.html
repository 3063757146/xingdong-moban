{% load static %}
<style>
.recharge-box {
    width: 400px;
    margin: 20px auto;
    text-align: center;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.recharge-title {
    font-size: 24px;
    font-weight: bold;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
}

.recharge-amount {
    font-size: 18px;
    color: #333;
    margin-bottom: 25px;
}

.amount-input-section {
    margin-bottom: 25px;
    text-align: left;
}

.amount-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.amount-input-group {
    position: relative;
    display: flex;
    align-items: center;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0;
    transition: all 0.3s ease;
}

.amount-input-group:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.amount-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 16px 18px;
    font-size: 16px;
    color: #374151;
    outline: none;
}

.amount-input::placeholder {
    color: #9ca3af;
}

.amount-unit {
    padding: 0 18px;
    color: #6b7280;
    font-weight: 600;
    font-size: 16px;
}

.amount-preview {
    margin-top: 10px;
    text-align: center;
}

#pointsPreview {
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 600;
    font-size: 14px;
}

.pay-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 15px 40px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.pay-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.pay-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.qrcode-container {
    margin-top: 25px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 15px;
    border: 2px solid #e2e8f0;
}

#qrcode-container {
    margin: 0 auto;
    width: 200px;
    height: 200px;
    background: white;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.qr-message {
    margin-top: 15px;
    color: #666;
    font-size: 14px;
}

.amount-display {
    color: #ff6600;
    font-weight: bold;
    font-size: 16px;
    margin-top: 10px;
}

.web-pay-section {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

.web-pay-btn {
    background: linear-gradient(45deg, #52c41a, #73d13d);
    color: white;
    text-decoration: none;
    border-radius: 20px;
    padding: 10px 25px;
    font-size: 14px;
    font-weight: 600;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(82, 196, 26, 0.3);
}

.web-pay-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(82, 196, 26, 0.4);
    color: white;
    text-decoration: none;
}

.help-text {
    font-size: 12px;
    color: #999;
    margin-top: 8px;
}

.success-message {
    color: #52c41a !important;
    font-weight: bold;
}

/* æ”¯ä»˜æˆåŠŸå¼¹çª—æ ·å¼ */
.payment-success-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.success-modal-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: successModalIn 0.5s ease-out;
}

@keyframes successModalIn {
    0% {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.success-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #52c41a, #73d13d);
    border-radius: 50%;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: white;
    animation: successIconPulse 1s ease-in-out;
}

@keyframes successIconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.success-title {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.success-subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 20px;
}

.success-details {
    background: #f8fafc;
    border-radius: 10px;
    padding: 15px;
    margin: 20px 0;
    text-align: left;
}

.success-detail-item {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 14px;
}

.success-detail-label {
    color: #666;
}

.success-detail-value {
    color: #333;
    font-weight: 600;
}

.countdown-timer {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    display: inline-block;
    font-weight: bold;
    margin-top: 20px;
}

/* çƒŸèŠ±æ•ˆæœ */
.fireworks {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
}

.firework {
    position: absolute;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    animation: firework 1s ease-out forwards;
}

@keyframes firework {
    0% {
        transform: scale(0);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 0;
    }
}
</style>

<div class="recharge-box">
    <div class="recharge-title">ç§¯åˆ†å……å€¼</div>
    <div class="recharge-amount">1 å…ƒ = 10 ç§¯åˆ†</div>
    
    <div class="amount-input-section">
        <label for="amountInput" class="amount-label">å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <div class="amount-input-group">
            <input type="number" id="amountInput" class="amount-input" placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢" min="1" step="0.01" value="1">
            <span class="amount-unit">å…ƒ</span>
        </div>
        <div class="amount-preview">
            <span id="pointsPreview">é¢„è®¡è·å¾—ï¼š10 ç§¯åˆ†</span>
        </div>
    </div>
    
    <button id="btnPay" class="pay-btn">ç«‹å³å……å€¼</button>
    
    <div id="qrcode" style="display:none;" class="qrcode-container">
        <div id="qrcode-container"></div>
        <p id="msg" class="qr-message">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</p>
        <p id="amount" class="amount-display">æ”¯ä»˜é‡‘é¢ï¼šÂ¥0.10</p>
        
        <div id="web-pay" class="web-pay-section">
            <!-- <a id="webPayLink" href="#" target="_blank" class="web-pay-btn" style="display:none;">
                ğŸ’» ç”µè„‘ç«¯æ”¯ä»˜ï¼ˆæ¨èï¼‰
            </a> -->
            <p class="help-text">ä½¿ç”¨æ”¯ä»˜å®APPæ‰«ç </p>
        </div>
    </div>
</div>

<!-- æ”¯ä»˜æˆåŠŸå¼¹çª— -->
<div id="paymentSuccessModal" class="payment-success-modal">
    <div class="success-modal-content">
        <div class="success-icon">âœ“</div>
        <div class="success-title">æ”¯ä»˜æˆåŠŸï¼</div>
        <div class="success-subtitle">æ­å–œæ‚¨ï¼Œç§¯åˆ†å·²åˆ°è´¦</div>
        
        <div class="success-details">
            <div class="success-detail-item">
                <span class="success-detail-label">æ”¯ä»˜é‡‘é¢ï¼š</span>
                <span class="success-detail-value">Â¥1.00</span>
            </div>
            <div class="success-detail-item">
                <span class="success-detail-label">è·å¾—ç§¯åˆ†ï¼š</span>
                <span class="success-detail-value">10 ç§¯åˆ†</span>
            </div>
            <!-- <div class="success-detail-item">
                <span class="success-detail-label">è®¢å•å·ï¼š</span>
                <span class="success-detail-value" id="successOrderNo">-</span>
            </div> -->
        </div>
        
        <div class="countdown-timer" id="countdownTimer">
            5ç§’åè‡ªåŠ¨è¿”å›ç”¨æˆ·ä¸­å¿ƒ
        </div>
    </div>
</div>

<!-- çƒŸèŠ±æ•ˆæœå®¹å™¨ -->
<div id="fireworks" class="fireworks"></div>

<!-- å¼•å…¥ qrcodejs åº“ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼ŒCDN å¤‡ç”¨ï¼‰ -->
<script src="/static/js/qrcode.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js'"></script>
<script src="/static/js/jquery.min.js"></script>
<script>
$(document).ready(function(){
    let currentTimer = null;
    let currentAmount = 1;
    
    // é‡‘é¢è¾“å…¥å®æ—¶é¢„è§ˆ
    $('#amountInput').on('input', function(){
        const amount = parseFloat($(this).val()) || 0;
        currentAmount = amount;
        const points = Math.floor(amount * 10); // 1å…ƒ=10ç§¯åˆ†
        $('#pointsPreview').text(`é¢„è®¡è·å¾—ï¼š${points} ç§¯åˆ†`);
        
        // éªŒè¯é‡‘é¢
        if (amount < 1) {
            $('#btnPay').prop('disabled', true);
            $('#pointsPreview').text('æœ€ä½å……å€¼é‡‘é¢ï¼š1å…ƒ');
        } else if (amount > 10000) {
            $('#btnPay').prop('disabled', true);
            $('#pointsPreview').text('å•æ¬¡å……å€¼ä¸èƒ½è¶…è¿‡10000å…ƒ');
        } else {
            $('#btnPay').prop('disabled', false);
        }
    });
    
    $('#btnPay').off('click').on('click', function(){
        const amount = parseFloat($('#amountInput').val()) || 1;
        if (amount < 1) {
            showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢', 'error');
            return;
        }
        
        let $btn = $(this);
        $btn.prop('disabled', true).text('ğŸ”„ ç”Ÿæˆä¸­...');
        
        $.getJSON("{% url 'alipay_qrcode' %}", {amount: amount}, function(res){
            if(res.code !== 0){
                showMessage(res.msg, 'error');
                $btn.prop('disabled', false).text('ç«‹å³å……å€¼');
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„äºŒç»´ç 
            $('#qrcode-container').empty();
            
            // ä½¿ç”¨ qrcodejs ç”ŸæˆäºŒç»´ç 
            try {
                new QRCode(document.getElementById("qrcode-container"), {
                    text: res.qr,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                $('#qrcode').show();
                $btn.text('âœ… å·²ç”Ÿæˆæ”¯ä»˜');
                
                // æ›´æ–°æ”¯ä»˜é‡‘é¢æ˜¾ç¤º
                $('#amount').text(`æ”¯ä»˜é‡‘é¢ï¼šÂ¥${amount.toFixed(2)}`);
                
                console.log('æ”¯ä»˜é“¾æ¥:', res.qr);
                console.log('è®¢å•ID:', res.oid);
                console.log('æ”¯ä»˜é‡‘é¢:', amount);
                
                // å¦‚æœæœ‰ç½‘é¡µæ”¯ä»˜é“¾æ¥ï¼Œæ˜¾ç¤ºæŒ‰é’®
                // if(res.web_url) {
                //     console.log('ç½‘é¡µæ”¯ä»˜é“¾æ¥:', res.web_url);
                //     $('#webPayLink').attr('href', res.web_url).show();
                //     // $('#msg').text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨ç½‘é¡µæ”¯ä»˜');
                // }
                
            } catch(e) {
                console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', e);
                showMessage('äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
                $btn.prop('disabled', false).text('ç«‹å³å……å€¼');
                return;
            }
            
            // è½®è¯¢æ”¯ä»˜ç»“æœ
            let oid = res.oid;
            if (currentTimer) {
                clearInterval(currentTimer);
            }
            
            currentTimer = setInterval(function(){
                $.getJSON('/user/query_order/' + oid + '/', function(r){
                    if(r.status === 1){
                        clearInterval(currentTimer);
                        $('#msg').text('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼').addClass('success-message');
                        $btn.text('âœ… æ”¯ä»˜æˆåŠŸ');
                        
                        // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸå¼¹çª—
                        showPaymentSuccessModal(oid, amount);
                        
                        // å¯åŠ¨çƒŸèŠ±æ•ˆæœ
                        createFireworks();
                    }
                }).fail(function(){
                    console.log('æŸ¥è¯¢è®¢å•çŠ¶æ€å¤±è´¥');
                });
            }, 1500);
            
        }).fail(function(){
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            $btn.prop('disabled', false).text('ç«‹å³å……å€¼');
        });
    });
    
    // æ¶ˆæ¯æç¤ºå‡½æ•°
    function showMessage(msg, type) {
        const colors = {
            'success': '#52c41a',
            'error': '#ff4d4f',
            'info': '#1890ff'
        };
        
        // åˆ›å»ºæç¤ºæ¡†
        const toast = $(`
            <div style="
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transition: opacity 0.3s ease;
            ">${msg}</div>
        `);
        
        $('body').append(toast);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => toast.css('opacity', 1), 100);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            toast.css('opacity', 0);
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸå¼¹çª—
    function showPaymentSuccessModal(oid, amount) {
        // è®¾ç½®è®¢å•å·
        // $('#successOrderNo').text(oid);
        
        // æ›´æ–°æ”¯ä»˜é‡‘é¢å’Œç§¯åˆ†
        const points = Math.floor(amount * 10); // 1å…ƒ=10ç§¯åˆ†
        $('#paymentSuccessModal .success-detail-value').eq(0).text(`Â¥${amount.toFixed(2)}`);
        $('#paymentSuccessModal .success-detail-value').eq(1).text(`${points} ç§¯åˆ†`);
        
        // æ˜¾ç¤ºå¼¹çª—
        $('#paymentSuccessModal').css('display', 'flex');
        
        // å¯åŠ¨å€’è®¡æ—¶
        let countdown = 5;
        const timerElement = $('#countdownTimer');
        
        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                timerElement.text(`${countdown}ç§’åè‡ªåŠ¨è¿”å›ç”¨æˆ·ä¸­å¿ƒ`);
            } else {
                clearInterval(countdownInterval);
                timerElement.text('æ­£åœ¨è·³è½¬...');
                
                // è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
                setTimeout(() => {
                    window.location.href = '/user/center/';
                }, 500);
            }
        }, 1000);
    }
    
    // åˆ›å»ºçƒŸèŠ±æ•ˆæœ
    function createFireworks() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
        const fireworks = $('#fireworks');
        
        // æ¸…é™¤ä¹‹å‰çš„çƒŸèŠ±
        fireworks.empty();
        
        // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
        for (let i = 0; i < 20; i++) {
            setTimeout(() => {
                const firework = $('<div class="firework"></div>');
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                firework.css({
                    'background-color': color,
                    'left': Math.random() * 100 + '%',
                    'top': Math.random() * 100 + '%',
                    'animation-delay': Math.random() * 0.5 + 's'
                });
                
                fireworks.append(firework);
                
                // 1ç§’åç§»é™¤çƒŸèŠ±å…ƒç´ 
                setTimeout(() => {
                    firework.remove();
                }, 1000);
            }, i * 50);
        }
    }
});
</script>

