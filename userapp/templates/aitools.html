{% extends 'layout.html' %}

{% block title %}Sora2 视频生成{% endblock %}

{% block main %}
<div id="app">
    <!-- 1. 顶部标题 -->
    <h2 class="title">效果预览</h2>
    <p class="subtitle">这是该模型可以达到的生成效果。下方输入提示词即可开始创作。</p>

    <!-- 2. 视频预览卡片（空态 / 视频态） -->
    <div id="previewCard">
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="#4d4d4d">
                <polygon points="18,12 36,24 18,36"></polygon>
            </svg>
            <p class="note">目前暂不支持真人或者类似真人的图片当参考图</p>
        </div>
    </div>

    <!-- 3. 提示词 + 上传图片 -->
    <div class="prompt-line">
        <div class="upload-box">
            <label for="imageInput" class="upload-btn">📎 添加图片</label>
            <input type="file" id="imageInput" accept="image/*" style="display:none;">
            <img id="previewImage" class="preview-thumb" style="display:none;">
        </div>
        <textarea id="prompt" placeholder="描述你想要生成的视频内容.."></textarea>
    </div>

    <!-- 4. 主按钮 -->
    <button id="submitBtn" class="submit-btn" >立即生成</button>

    <!-- 5. 状态/进度 -->
    <div id="status"></div>
</div>
{% endblock %}
{% block css %}
<style>
#app {
    width: 640px;
    margin: 0 auto;
    text-align: left;
}
.title { font-size:24px; font-weight:600; margin-bottom:12px; }
.subtitle { font-size:14px; color:#b3b3b3; line-height:20px; margin-bottom:32px; }
#submitBtn {
    display: block;
    margin: 0 auto 12px auto; /* 上右下左，水平居中，下方留点间距 */
}
#previewCard {
    width: 100%;
    max-width:640px;
    aspect-ratio:16/9;
    border-radius:12px;
    background: radial-gradient(circle at center,#1a1a1a 0%,#0e0e0e 100%);
    border:1px solid #333;
    position:relative;
    margin-bottom:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
}
#previewCard .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; }
#previewCard video { width:100%; height:100%; object-fit:cover; border-radius:12px; }
#previewCard .note { position:absolute; bottom:12px; width:100%; text-align:center; color:#808080; font-size:12px; }

.prompt-line { display:flex; align-items:flex-start; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
.upload-box { display:flex; flex-direction:column; align-items:center; }
.upload-btn { margin-top:30px; display:flex; align-items:center; justify-content:center; height:15px; line-height:15px; cursor:pointer; color:#00ff66; font-weight:500; }
.upload-btn:hover { filter: brightness(1.2); }
.preview-thumb { width:64px; height:64px; object-fit:cover; border-radius:6px; border:1px solid #333; margin-top:8px; }

textarea { flex:1 1 auto; min-width:200px; height:100px; border-radius:8px; background:#1a1a1a; border:1px solid #333; color:#fff; padding:12px; font-size:14px; resize:none; outline:none; transition:all 0.3s; }
textarea:focus { border-color:#00ff66; box-shadow:0 0 0 2px #00ff6622; }
textarea::placeholder { color:#666; }

button { width:140px; height:40px; border:none; border-radius:8px; background:linear-gradient(90deg,#00ff66 0%,#00dd55 100%); color:#000; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s; margin-bottom:12px; }
button:hover { filter: brightness(1.1); }
button:active { transform:scale(0.98); }
button:disabled { background:#333; color:#666; cursor:not-allowed; filter:none; }

#status { height:20px; margin-top:12px; font-size:12px; color:#00ff66; }

/* 响应式 */
@media(max-width:720px){
    #app { width:92vw; max-width:640px; }
    button { width:100%; }
    #previewCard, video { width:100%; height:calc(100vw*9/16); }
}
</style>
{% endblock %}

{% block js %}
<script>
const STATUS = document.getElementById('status');
const BTN = document.getElementById('submitBtn');
const IMAGE_INPUT = document.getElementById('imageInput');
const PREVIEW_IMG = document.getElementById('previewImage');

IMAGE_INPUT.onchange = () => {
    const file = IMAGE_INPUT.files[0];
    if (file) {
        PREVIEW_IMG.src = URL.createObjectURL(file);
        PREVIEW_IMG.style.display = 'block';
    } else {
        PREVIEW_IMG.style.display = 'none';
    }
};

BTN.onclick = async () => {
    const prompt = document.getElementById('prompt').value.trim();
    const file = IMAGE_INPUT.files[0];
    if (!prompt && !file) return alert('请先输入提示词或上传图片');

    BTN.disabled = true;
    STATUS.textContent = '提交中…';

    try {
        // 1️⃣ 提交任务
        const formData = new FormData();
        formData.append('prompt', prompt);
        if (file) formData.append('image', file);

        const r1 = await fetch('/ai/video_submit/', { method: 'POST', body: formData });
        const j1 = await r1.json();
        if (j1.error) throw new Error(j1.error);

        const taskId = j1.task_id;
        if (!taskId) throw new Error('任务创建失败');

        STATUS.textContent = '任务已创建，正在生成中…';

        // 2️⃣ 开始轮询结果
        let retry = 0;
        const maxRetry = 200; // 最多轮询 40 次（约 2 分钟）
        const interval = 5000; // 每 3 秒请求一次

        const poll = setInterval(async () => {
            retry++;
            console.log(`🔁 正在查询生成进度... (${retry}/${maxRetry})`);

            try {
                const r2 = await fetch(`/ai/video_result/?task=${taskId}`);
                const j2 = await r2.json();

                // 后端标准化返回：{ url, status }
                // 轮询内部核心判断
            if (j2.status === 'completed' && j2.video_url) {
                clearInterval(poll);
                STATUS.textContent = '✅ 视频生成完成！';
                const card = document.getElementById('previewCard');
                card.innerHTML = '';
                const v = document.createElement('video');
                v.src = j2.video_url;
                v.controls = true;
                v.autoplay = true;
                v.style.width = '100%';
                card.appendChild(v);
                BTN.disabled = false;
                return;
            }
            if (j2.status === 'failed') {
                clearInterval(poll);
                STATUS.innerHTML = `<span class="error">${j2.error || '系统错误'}</span>`;
                BTN.disabled = false;
                return;
            }

                STATUS.textContent = `生成中... (${retry * 5} 秒)`;

                if (retry >= maxRetry) {
                    clearInterval(poll);
                    throw new Error('生成超时，请重试');
                }
            } catch (err) {
                clearInterval(poll);
                STATUS.innerHTML = `<span class="error">${err.message}</span>`;
                BTN.disabled = false;
            }
        }, interval);
    } catch (e) {
        STATUS.innerHTML = `<span class="error">${e.message}</span>`;
        BTN.disabled = false;
    }
};
</script>

{% endblock %}
