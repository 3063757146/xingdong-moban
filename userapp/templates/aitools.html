{% extends 'layout.html' %}

{% block title %}Sora2 è§†é¢‘ç”Ÿæˆ{% endblock %}

{% block main %}
<div id="app">
    <!-- 1. é¡¶éƒ¨æ ‡é¢˜ -->
    <h2 class="title">æ•ˆæœé¢„è§ˆ</h2>
    <p class="subtitle">è¿™æ˜¯è¯¥æ¨¡å‹å¯ä»¥è¾¾åˆ°çš„ç”Ÿæˆæ•ˆæœã€‚ä¸‹æ–¹è¾“å…¥æç¤ºè¯å³å¯å¼€å§‹åˆ›ä½œã€‚</p>

    <!-- 2. è§†é¢‘é¢„è§ˆå¡ç‰‡ï¼ˆç©ºæ€ / è§†é¢‘æ€ï¼‰ -->
    <div id="previewCard">
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="#4d4d4d">
                <polygon points="18,12 36,24 18,36"></polygon>
            </svg>
            <p class="note">ç›®å‰æš‚ä¸æ”¯æŒçœŸäººæˆ–è€…ç±»ä¼¼çœŸäººçš„å›¾ç‰‡å½“å‚è€ƒå›¾</p>
        </div>
    </div>

    <!-- 3. æç¤ºè¯ + ä¸Šä¼ å›¾ç‰‡ -->
    <div class="prompt-line">
        <div class="upload-box">
            <label for="imageInput" class="upload-btn">ğŸ“ æ·»åŠ å›¾ç‰‡</label>
            <input type="file" id="imageInput" accept="image/*" style="display:none;">
            <img id="previewImage" class="preview-thumb" style="display:none;">
        </div>
        <textarea id="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹.."></textarea>
    </div>

    <!-- 4. ä¸»æŒ‰é’® -->
    <button id="submitBtn" class="submit-btn" >ç«‹å³ç”Ÿæˆ</button>

    <!-- 5. çŠ¶æ€/è¿›åº¦ -->
    <div id="status"></div>
</div>
{% endblock %}

{% block css %}
<style>
/* body {
    background: #e7e6e6;
    color: #fff;
    font-family: Inter, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
    font-size: 14px;
    line-height: 1.5;
    margin: 0;
    padding-top: 60px;
} */

#app {
    width: 640px;
    margin: 0 auto;
    text-align: left;
}
#submitBtn {
    display: block;
    margin: 0 auto 12px auto; /* ä¸Šå³ä¸‹å·¦ï¼Œæ°´å¹³å±…ä¸­ï¼Œä¸‹æ–¹ç•™ç‚¹é—´è· */
}
.title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 12px;
}

.subtitle {
    font-size: 14px;
    color: #b3b3b3;
    line-height: 20px;
    margin-bottom: 32px;
}

/* ===== é¢„è§ˆå¡ç‰‡ï¼ˆç©ºæ€ & è§†é¢‘æ€ï¼‰ ===== */
#previewCard {
    width: 640px;
    height: 360px;
    border-radius: 12px;
    background: radial-gradient(circle at center, #1a1a1a 0%, #0e0e0e 100%);
    border: 1px solid #333;
    position: relative;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.3s;
    overflow: hidden;
}

#previewCard:hover {
    border-color: #555;
}

#previewCard .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

#previewCard svg {
    display: block;
}

#previewCard .note {
    position: absolute;
    bottom: 12px;
    width: 100%;
    text-align: center;
    color: #808080;
    font-size: 12px;
}

#previewCard video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
}

/* ===== æç¤ºè¯ + ä¸Šä¼  ===== */
.prompt-line {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
}

.upload-box {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.upload-btn {
    margin-top: 30px;
    display: flex;
    align-items: center;
    justify-content: center;

    height: 15px;      /* å›ºå®šé«˜åº¦ï¼Œé¿å…å‡ºç°é»‘å— */
    line-height: 15px; /* ä¸é«˜åº¦ä¸€è‡´ */
}

.upload-btn:hover {
    filter: brightness(1.2);
}

.preview-thumb {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #333;
    margin-top: 8px;
}

textarea {
    flex: 1 1 auto;
    height: 100px;
    border-radius: 8px;
    background: #1a1a1a;
    border: 1px solid #333;
    color: #fff;
    padding: 12px;
    font-size: 14px;
    resize: none;
    outline: none;
    transition: all 0.3s;
}

textarea:focus {
    border-color: #00ff66;
    box-shadow: 0 0 0 2px #00ff6622;
}

textarea::placeholder {
    color: #666;
}

/* ===== æŒ‰é’® & çŠ¶æ€ ===== */
button {
    width: 140px;
    height: 40px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(90deg, #00ff66 0%, #00dd55 100%);
    color: #000;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

button:hover {
    filter: brightness(1.1);
}

button:active {
    transform: scale(0.98);
}

button:disabled {
    background: #333;
    color: #666;
    cursor: not-allowed;
    filter: none;
}

#status {
    height: 20px;
    margin-top: 12px;
    font-size: 12px;
    color: #00ff66;
}

/* ===== å“åº”å¼ ===== */
@media (max-width: 720px) {
    #app {
        width: 92vw;
        max-width: 640px;
    }
    button {
        width: 100%;
    }
    #previewCard,
    video {
        width: 100%;
        height: calc(100vw * 9 / 16);
    }
}
</style>
{% endblock %}

{% block js %}
<script>
const STATUS = document.getElementById('status');
const BTN = document.getElementById('submitBtn');
const IMAGE_INPUT = document.getElementById('imageInput');
const PREVIEW_IMG = document.getElementById('previewImage');

/* å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ */
IMAGE_INPUT.onchange = () => {
    const file = IMAGE_INPUT.files[0];
    if (file) {
        PREVIEW_IMG.src = URL.createObjectURL(file);
        PREVIEW_IMG.style.display = 'block';
    } else {
        PREVIEW_IMG.style.display = 'none';
    }
};

/* ç”ŸæˆæŒ‰é’®é€»è¾‘ */
BTN.onclick = async () => {
    const prompt = document.getElementById('prompt').value.trim();
    const file = IMAGE_INPUT.files[0];
    if (!prompt && !file) return alert('è¯·å…ˆè¾“å…¥æç¤ºè¯æˆ–ä¸Šä¼ å›¾ç‰‡');

    BTN.disabled = true;
    STATUS.textContent = 'æäº¤ä¸­â€¦';

    try {
        const formData = new FormData();
        formData.append('prompt', prompt);
        if (file) formData.append('image', file);

        const r1 = await fetch('/ai/video_submit/', { method: 'POST', body: formData });
        const j1 = await r1.json();
        if (j1.error) throw new Error(j1.error);

        STATUS.textContent = 'ä»»åŠ¡å·²åˆ›å»ºï¼Œæ­£åœ¨ç”Ÿæˆä¸­â€¦';

        let count = 0;
        const poll = setInterval(async () => {
            count++;
            const r2 = await fetch(`/ai/video_result/?task=${j1.task_id}`);
            const j2 = await r2.json();
            if (j2.error) {
                clearInterval(poll);
                throw new Error(j2.error);
            }

            if (j2.status === 'completed') {
                clearInterval(poll);
                STATUS.textContent = 'ç”Ÿæˆå®Œæˆï¼';

                // å°†è§†é¢‘å¡è¿›é¢„è§ˆå¡ç‰‡
                const card = document.getElementById('previewCard');
                card.innerHTML = '';
                const v = document.createElement('video');
                v.src = j2.video_url;
                v.controls = true;
                v.autoplay = true;
                card.appendChild(v);

                BTN.disabled = false;
            } else if (j2.status === 'failed') {
                clearInterval(poll);
                throw new Error('ä»»åŠ¡å¤±è´¥');
            } else {
                STATUS.textContent = `ç”Ÿæˆä¸­ ${j2.status} â€¦`;
            }

            if (count >= 60) {
                clearInterval(poll);
                throw new Error('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•');
            }
        }, 3000);
    } catch (e) {
        STATUS.innerHTML = `<span class="error">${e.message}</span>`;
        BTN.disabled = false;
    }
};
</script>
{% endblock %}
