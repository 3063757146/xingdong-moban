{% load static %}
<div class="recharge-box" style="width:350px;margin:20px auto;text-align:center">
    <h4>0.1 元充 10 积分（测试模式）</h4>
    <p style="color:#999;font-size:12px;">沙箱扫码不可用时使用</p>
    <button id="btnPay" class="am-btn am-btn-danger">立即充值</button>
    <button id="btnTestPay" class="am-btn am-btn-warning" style="margin-left:10px;">测试支付（跳过扫码）</button>
    <div id="qrcode" style="display:none;margin-top:15px">
        <div id="qrcode-container" style="margin:0 auto;width:200px;height:200px;"></div>
        <p id="msg" style="margin-top:10px;color:#666;">请使用支付宝扫码支付</p>
        <p id="amount" style="color:#ff6600;font-weight:bold;">支付金额：¥0.10</p>
        <div style="margin-top:15px;">
            <p style="font-size:12px;color:#999;">
                <a href="https://open.alipay.com/develop/sandbox/app" target="_blank">获取沙箱买家账号</a>
            </p>
            <button id="btnSimulatePay" class="am-btn am-btn-sm am-btn-success" style="margin-top:10px;">
                模拟支付成功（测试用）
            </button>
        </div>
    </div>
</div>

<!-- 引入 qrcodejs 库（本地优先，CDN 备用） -->
<script src="/static/js/qrcode.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js'"></script>
<script src="/static/js/jquery.min.js"></script>
<script>
$(document).ready(function(){
    let currentTimer = null;
    let currentOid = null;
    
    // 正常充值流程（生成二维码）
    $('#btnPay').off('click').on('click', function(){
        generateQRCode(false);
    });
    
    // 测试支付（直接标记为已支付）
    $('#btnTestPay').off('click').on('click', function(){
        if(!confirm('这将直接增加积分，仅用于测试。确认吗？')) return;
        
        $.post("{% url 'test_pay' %}", {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(res){
            if(res.code === 0){
                alert('测试支付成功！积分已到账');
                location.reload();
            } else {
                alert(res.msg || '测试支付失败');
            }
        });
    });
    
    // 生成二维码
    function generateQRCode(isTest){
        let $btn = $('#btnPay');
        $btn.prop('disabled', true).text('生成中...');
        
        $.getJSON("{% url 'alipay_qrcode' %}", function(res){
            if(res.code !== 0){
                alert(res.msg);
                $btn.prop('disabled', false).text('立即充值');
                return;
            }
            
            // 清空之前的二维码
            $('#qrcode-container').empty();
            
            // 使用 qrcodejs 生成二维码
            try {
                new QRCode(document.getElementById("qrcode-container"), {
                    text: res.qr,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                $('#qrcode').show();
                $btn.text('已生成二维码');
                
                currentOid = res.oid;
                console.log('支付链接:', res.qr);
                console.log('订单ID:', res.oid);
                
                // 启动轮询
                startPolling(res.oid);
                
            } catch(e) {
                console.error('二维码生成失败:', e);
                alert('二维码生成失败，请刷新重试');
                $btn.prop('disabled', false).text('立即充值');
            }
        }).fail(function(){
            alert('网络错误，请重试');
            $btn.prop('disabled', false).text('立即充值');
        });
    }
    
    // 模拟支付成功（手动标记订单为已支付）
    $('#btnSimulatePay').off('click').on('click', function(){
        if(!currentOid){
            alert('请先生成订单');
            return;
        }
        
        if(!confirm('这将模拟支付成功，仅用于测试。确认吗？')) return;
        
        let $btn = $(this);
        $btn.prop('disabled', true).text('处理中...');
        
        $.post("/user/simulate_pay/", {
            oid: currentOid,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(res){
            if(res.code === 0){
                $('#msg').text('支付成功！').css('color', '#52c41a');
                setTimeout(function(){
                    alert('充值成功！积分已到账');
                    location.reload();
                }, 500);
            } else {
                alert(res.msg || '操作失败');
                $btn.prop('disabled', false).text('模拟支付成功（测试用）');
            }
        });
    });
    
    // 轮询支付结果
    function startPolling(oid){
        if (currentTimer) {
            clearInterval(currentTimer);
        }
        
        currentTimer = setInterval(function(){
            $.getJSON('/user/query_order/' + oid + '/', function(r){
                if(r.status === 1){
                    clearInterval(currentTimer);
                    $('#msg').text('支付成功！').css('color', '#52c41a');
                    setTimeout(function(){
                        alert('充值成功！积分已到账');
                        location.reload();
                    }, 500);
                }
            });
        }, 1500);
    }
});
</script>

